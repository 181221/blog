<!doctype html>
<html>
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <title></title>
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <link rel="stylesheet" href="css/main.css">
    </head>
    <body>
        <!--[if lt IE 8]>
            <p class="browsehappy">You are using an <strong>outdated</strong> browser. Please <a href="http://browsehappy.com/">upgrade your browser</a> to improve your experience.</p>
        <![endif]-->

        <p>Most CCK Field modules have a widget where the user adds information upon creating a node which is then saved with the node. For the recent <a href="http://drupal.org/project/etherpad">Etherpad module</a> I wrote, I needed an &quot;invisible&quot; widget which saved with each new node some information from the field definition as well as autogenerated information. As I didn&#39;t any documentation on how to do this, I thought I&#39;d document it here quickly.  </p>
<p>The first thing you do is define your database columns for your field in hook_field_settings.  </p>
<p>function etherpad_field_settings($op, $field) {  </p>
<p>switch ($op) {  </p>
<p>// Code removed.  </p>
<p>case &#39;database columns&#39;:  </p>
<p>return array(  </p>
<p>&#39;etherpad_url&#39; => array(&#39;type&#39; => &#39;varchar&#39;, &#39;length&#39; => 1024, &#39;not null&#39; => FALSE,),  </p>
<p>&#39;etherpad_text&#39; => array(&#39;type&#39; => &#39;text&#39;, &#39;not null&#39; => TRUE, &#39;size&#39; => &#39;big&#39;),  </p>
<p>&#39;attributes&#39; => array(&#39;type&#39; => &#39;text&#39;, &#39;size&#39; => &#39;medium&#39;, &#39;not null&#39; => FALSE),  </p>
<p>);  </p>
<p>}  </p>
<p>}  </p>
<p>?>  </p>
<p>Next, you define your widget form inside hook_widget. Some tutorials I saw suggest you define your widget form in hook_elements/hook_process. I did that at first but decided against it as a) I never got it to work and b) it just adds needless complexity. Generally you&#39;ll just want to define your widget in hook_widgets.  </p>
<p>Two really important things here to get your &quot;invisible&quot; widget to work correctly. First, you <strong>must</strong> name your form keys the same as you named your database column names in hook_field_settings. This tripped me up for a long time. CCK saves data by magic (you never explicitly save anything from a widget) and this is the key to getting the incantation to take. Second, using the &quot;<a href="http://api.drupal.org/api/drupal/developer--topics--forms_api_reference.html/6#val">value&quot; field type</a> was the key to creating an &quot;invisible&quot; field and getting my data saved correctly.  </p>
<p>/**  </p>
<p>* Implementation of hook_widget().  </p>
<p>*/  </p>
<p>function etherpad_widget(&amp;$form, &amp;$form_state, $field, $items, $delta = 0) {  </p>
<p>$element[&#39;etherpad_url&#39;] = array(  </p>
<p>&#39;#type&#39; => &#39;value&#39;,  </p>
<p>&#39;#value&#39; => (isset($items[$delta][&#39;etherpad_url&#39;]) &amp;&amp; !empty($form[&#39;nid&#39;][&#39;#value&#39;])) ? $items[$delta][&#39;etherpad_url&#39;] : $field[&#39;etherpad_url&#39;] . etherpad_generate_padid($field[&#39;etherpad_url&#39;]),  </p>
<p>);  </p>
<p>$element[&#39;etherpad_text&#39;] = array(  </p>
<p>&#39;#type&#39; => &#39;value&#39;,  </p>
<p>&#39;#value&#39; => (isset($items[$delta][&#39;etherpad_text&#39;]) &amp;&amp; !empty($form[&#39;nid&#39;][&#39;#value&#39;])) ? $items[$delta][&#39;etherpad_text&#39;] : &quot;default value for now until we have a function to generate one&quot;,  </p>
<p>);  </p>
<p>$element[&#39;attributes&#39;] = array(  </p>
<p>&#39;#type&#39; => &#39;value&#39;,  </p>
<p>&#39;#value&#39; => (isset($items[$delta][&#39;attributes&#39;]) &amp;&amp; !empty($form[&#39;nid&#39;][&#39;#value&#39;])) ? $items[$delta][&#39;attributes&#39;] : serialize($field[&#39;attributes&#39;]),  </p>
<p>);  </p>
<p>// Used so that hook_field(&#39;validate&#39;) knows where to   </p>
<p>// flag an error in deeply nested forms.  </p>
<p>if (empty($form[&#39;#parents&#39;])) {  </p>
<p>$form[&#39;#parents&#39;] = array();  </p>
<p>}  </p>
<p>$element[&#39;_error_element&#39;] = array(  </p>
<p>&#39;#type&#39; => &#39;value&#39;,  </p>
<p>&#39;#value&#39; => implode(&#39;][&#39;, array_merge($form[&#39;#parents&#39;], array(&#39;value&#39;))),  </p>
<p>);  </p>
<p>return $element;  </p>
<p>}  </p>
<p>?>  </p>
<p>And that&#39;s it! Read this and you&#39;ll save yourself hours of frustration :)  </p>
<p>One other note, the Devel module&#39;s &quot;reinstall module&quot; function is very useful as you&#39;ll be reinstalling the module often to reset the database w/ your changes. Enable the Devel block to access it.  </p>
<p>This documentation doesn&#39;t cover most of what you&#39;ll need to know to write a CCK module. I relied heavily on the following tutorials.  </p>
<ul>
<li><p><a href="http://maxeydevbox.org/blogs/geoffmaxey/building-custom-compound-fieldswidgets-cck-drupal-6x">http://maxeydevbox.org/blogs/geoffmaxey/building-custom-compound-fieldswidgets-cck-drupal-6x</a>  </p>
</li>
<li><p><a href="http://www.lullabot.com/articles/creating-custom-cck-fields">http://www.lullabot.com/articles/creating-custom-cck-fields</a>  </p>
</li>
<li><p><a href="http://www.poplarware.com/articles/cck\_field\_module">http://www.poplarware.com/articles/cck\_field\_module</a>  </p>
</li>
</ul>

        <script src="js/main.js"></script>

        <script>
            (function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=
            function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;
            e=o.createElement(i);r=o.getElementsByTagName(i)[0];
            e.src='//www.google-analytics.com/analytics.js';
            r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));
            ga('create','UA-XXXXX-X');ga('send','pageview');
        </script>
    </body>
</html>
