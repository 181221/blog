<!doctype html>
<html>
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <title></title>
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <link rel="stylesheet" href="/assets/main.css">
        <link rel="stylesheet" href="//brick.a.ssl.fastly.net/Clear+Sans:700,700i/Linux+Libertine:400,400i,700/Inconsolata:400">
    </head>
    <body>
        <!--[if lt IE 8]>
            <p class="browsehappy">You are using an <strong>outdated</strong> browser. Please <a href="http://browsehappy.com/">upgrade your browser</a> to improve your experience.</p>
        <![endif]-->

        <h1>Creating a CCK Field module with an "invisible" widget</h1>
<p>Most CCK Field modules have a widget where the user adds information upon creating a node which is then saved with the node. For the recent <a href="http://drupal.org/project/etherpad">Etherpad module</a> I wrote, I needed an “invisible” widget which saved with each new node some information from the field definition as well as autogenerated information. As I didn’t any documentation on how to do this, I thought I’d document it here quickly.</p>
<p>The first thing you do is define your database columns for your field in hook_field_settings.</p>
<p>function etherpad_field_settings($op, $field) {</p>
<p>switch ($op) {</p>
<p>// Code removed.</p>
<p>case ‘database columns’:</p>
<p>return array(</p>
<p>‘etherpad_url’ =&gt; array(‘type’ =&gt; ‘varchar’, ‘length’ =&gt; 1024, ‘not null’ =&gt; FALSE,),</p>
<p>‘etherpad_text’ =&gt; array(‘type’ =&gt; ‘text’, ‘not null’ =&gt; TRUE, ‘size’ =&gt; ‘big’),</p>
<p>‘attributes’ =&gt; array(‘type’ =&gt; ‘text’, ‘size’ =&gt; ‘medium’, ‘not null’ =&gt; FALSE),</p>
<p>);</p>
<p>}</p>
<p>}</p>
<p>?&gt;</p>
<p>Next, you define your widget form inside hook_widget. Some tutorials I saw suggest you define your widget form in hook_elements/hook_process. I did that at first but decided against it as a) I never got it to work and b) it just adds needless complexity. Generally you’ll just want to define your widget in hook_widgets.</p>
<p>Two really important things here to get your “invisible” widget to work correctly. First, you <strong>must</strong> name your form keys the same as you named your database column names in hook_field_settings. This tripped me up for a long time. CCK saves data by magic (you never explicitly save anything from a widget) and this is the key to getting the incantation to take. Second, using the “<a href="http://api.drupal.org/api/drupal/developer--topics--forms_api_reference.html/6#val">value” field type</a> was the key to creating an “invisible” field and getting my data saved correctly.</p>
<p>/**</p>
<ul>
<li>Implementation of hook_widget().</li>
</ul>
<p>*/</p>
<p>function etherpad_widget(&amp;$form, &amp;$form_state, $field, $items, $delta = 0) {</p>
<p>$element[‘etherpad_url’] = array(</p>
<p>‘#type’ =&gt; ‘value’,</p>
<p>‘#value’ =&gt; (isset($items[$delta][‘etherpad_url’]) &amp;&amp; !empty($form[‘nid’][‘#value’])) ? $items[$delta][‘etherpad_url’] : $field[‘etherpad_url’] . etherpad_generate_padid($field[‘etherpad_url’]),</p>
<p>);</p>
<p>$element[‘etherpad_text’] = array(</p>
<p>‘#type’ =&gt; ‘value’,</p>
<p>‘#value’ =&gt; (isset($items[$delta][‘etherpad_text’]) &amp;&amp; !empty($form[‘nid’][‘#value’])) ? $items[$delta][‘etherpad_text’] : “default value for now until we have a function to generate one”,</p>
<p>);</p>
<p>$element[‘attributes’] = array(</p>
<p>‘#type’ =&gt; ‘value’,</p>
<p>‘#value’ =&gt; (isset($items[$delta][‘attributes’]) &amp;&amp; !empty($form[‘nid’][‘#value’])) ? $items[$delta][‘attributes’] : serialize($field[‘attributes’]),</p>
<p>);</p>
<p>// Used so that hook_field(‘validate’) knows where to</p>
<p>// flag an error in deeply nested forms.</p>
<p>if (empty($form[‘#parents’])) {</p>
<p>$form[‘#parents’] = array();</p>
<p>}</p>
<p>$element[‘_error_element’] = array(</p>
<p>‘#type’ =&gt; ‘value’,</p>
<p>‘#value’ =&gt; implode(‘][‘, array_merge($form[‘#parents’], array(‘value’))),</p>
<p>);</p>
<p>return $element;</p>
<p>}</p>
<p>?&gt;</p>
<p>And that’s it! Read this and you’ll save yourself hours of frustration :)</p>
<p>One other note, the Devel module’s “reinstall module” function is very useful as you’ll be reinstalling the module often to reset the database w/ your changes. Enable the Devel block to access it.</p>
<p>This documentation doesn’t cover most of what you’ll need to know to write a CCK module. I relied heavily on the following tutorials.</p>
<ul>
<li><a href="http://maxeydevbox.org/blogs/geoffmaxey/building-custom-compound-fieldswidgets-cck-drupal-6x"><a href="http://maxeydevbox.org/blogs/geoffmaxey/building-custom-compound-fieldswidgets-cck-drupal-6x">http://maxeydevbox.org/blogs/geoffmaxey/building-custom-compound-fieldswidgets-cck-drupal-6x</a></a></li>
<li><a href="http://www.lullabot.com/articles/creating-custom-cck-fields"><a href="http://www.lullabot.com/articles/creating-custom-cck-fields">http://www.lullabot.com/articles/creating-custom-cck-fields</a></a></li>
<li><a href="http://www.poplarware.com/articles/cck_field_module"><a href="http://www.poplarware.com/articles/cck_field_module">http://www.poplarware.com/articles/cck_field_module</a></a></li>
</ul>

        <script src="js/main.js"></script>

        <script>
            (function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=
            function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;
            e=o.createElement(i);r=o.getElementsByTagName(i)[0];
            e.src='//www.google-analytics.com/analytics.js';
            r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));
            ga('create','UA-XXXXX-X');ga('send','pageview');
        </script>
    </body>
</html>
