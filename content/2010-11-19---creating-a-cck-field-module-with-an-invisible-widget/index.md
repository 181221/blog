---
title: "Creating a CCK Field module with an \"invisible\" widget"
tags:
  - drupal
  - drupal planet
  - etherpad
  - drupal modules
date: "2010-11-19T00:14:48.000Z"
layout: post
---

Most CCK Field modules have a widget where the user adds information upon creating a node which is then saved with the node. For the recent [Etherpad module][0] I wrote, I needed an "invisible" widget which saved with each new node some information from the field definition as well as autogenerated information. As I didn't any documentation on how to do this, I thought I'd document it here quickly.  

  

The first thing you do is define your database columns for your field in hook\_field\_settings.  

  


function etherpad\_field\_settings($op, $field) {  

switch ($op) {  

// Code removed.  

case 'database columns':  

return array(  

'etherpad\_url' =\> array('type' =\> 'varchar', 'length' =\> 1024, 'not null' =\> FALSE,),  

'etherpad\_text' =\> array('type' =\> 'text', 'not null' =\> TRUE, 'size' =\> 'big'),  

'attributes' =\> array('type' =\> 'text', 'size' =\> 'medium', 'not null' =\> FALSE),  

);  

}  

}  

?\>  

  

Next, you define your widget form inside hook\_widget. Some tutorials I saw suggest you define your widget form in hook\_elements/hook\_process. I did that at first but decided against it as a) I never got it to work and b) it just adds needless complexity. Generally you'll just want to define your widget in hook\_widgets.  

  

Two really important things here to get your "invisible" widget to work correctly. First, you **must** name your form keys the same as you named your database column names in hook\_field\_settings. This tripped me up for a long time. CCK saves data by magic (you never explicitly save anything from a widget) and this is the key to getting the incantation to take. Second, using the "[value" field type][1] was the key to creating an "invisible" field and getting my data saved correctly.  

  


/\*\*  

\* Implementation of hook\_widget().  

\*/  

function etherpad\_widget(&$form, &$form\_state, $field, $items, $delta = 0) {  

$element\['etherpad\_url'\] = array(  

'\#type' =\> 'value',  

'\#value' =\> (isset($items\[$delta\]\['etherpad\_url'\]) && !empty($form\['nid'\]\['\#value'\])) ? $items\[$delta\]\['etherpad\_url'\] : $field\['etherpad\_url'\] . etherpad\_generate\_padid($field\['etherpad\_url'\]),  

);  

$element\['etherpad\_text'\] = array(  

'\#type' =\> 'value',  

'\#value' =\> (isset($items\[$delta\]\['etherpad\_text'\]) && !empty($form\['nid'\]\['\#value'\])) ? $items\[$delta\]\['etherpad\_text'\] : "default value for now until we have a function to generate one",  

);  

$element\['attributes'\] = array(  

'\#type' =\> 'value',  

'\#value' =\> (isset($items\[$delta\]\['attributes'\]) && !empty($form\['nid'\]\['\#value'\])) ? $items\[$delta\]\['attributes'\] : serialize($field\['attributes'\]),  

);  

// Used so that hook\_field('validate') knows where to   

// flag an error in deeply nested forms.  

if (empty($form\['\#parents'\])) {  

$form\['\#parents'\] = array();  

}  

$element\['\_error\_element'\] = array(  

'\#type' =\> 'value',  

'\#value' =\> implode('\]\[', array\_merge($form\['\#parents'\], array('value'))),  

);  

  

return $element;  

}  

?\>  

  

And that's it! Read this and you'll save yourself hours of frustration :)  

  

One other note, the Devel module's "reinstall module" function is very useful as you'll be reinstalling the module often to reset the database w/ your changes. Enable the Devel block to access it.  

  

This documentation doesn't cover most of what you'll need to know to write a CCK module. I relied heavily on the following tutorials.  


  

* http://maxeydevbox.org/blogs/geoffmaxey/building-custom-compound-fieldswidgets-cck-drupal-6x  

* http://www.lullabot.com/articles/creating-custom-cck-fields  

* http://www.poplarware.com/articles/cck\_field\_module  

  



[0]: http://drupal.org/project/etherpad
[1]: http://api.drupal.org/api/drupal/developer--topics--forms_api_reference.html/6#val